# Проверка GPG подписей коммитов и тегов в Git

Цель этой статьи – настроить в локальном Git-репозитории проверку GPG подписей коммитов и тегов. Дополнительно будет настроено подписание собственных коммитов и тегов с использование GPG ключа.

Предполагается, что за ведение списка допустимых подписантов (участников) репозитория отвечают один или несколько человек – доверенных лиц. Они формируют связку публичных GPG ключей допустимых подписантов и осуществляют передачу готовой конфигурации всем остальным участникам.

## Основные задачи

- Создать для работы с Git отдельное хранилище GPG ключей.
- Сгенерировать собственный GPG ключ для Git.
- Настроить в Git подписание собственных коммитов и тегов с использование GPG ключа.
- Создать для каждого репозитория отдельную связку публичных GPG ключей допустимых подписантов (участников репозитория). Это позволит управлять публичными GPG ключами участников каждого репозитория в отдельности.
- Настроить проверку GPG подписей в Git.
- Передать готовую конфигурацию остальным участникам.

## Соглашение об используемых каталогах

В качестве домашнего каталога gpg для Git выберем папку `~/.gnupg/git`.

Для данных относящихся к конкретному репозиторию, используем отдельную папку `~/.gnupg/git/<repo_name>`.

## Настройка домашнего каталога gpg для Git

Использование отдельного домашнего каталога gpg для Git позволит отделить конфигурацию gpg для Git от основной конфигурации gpg в системе и полностью исключит их влияние друг на друга.

Это означает, что все GPG ключи (как открытые, так и закрытые) имеющиеся в системе будут недоступны при указании нового домашнего каталога gpg. С другой стороны все новые GPG ключи (сгенерированные или импортированные) будут недоступны из основной системы и никак на нее не повлияют.

Если Вы планируете настроить только собственную GPG подпись для коммитов и тегов, от использования отдельного домашнего каталога gpg для Git, в целях упрощения конфигурации, можно отказаться.

Для установки домашнего каталога используется опция `--homedir dir` (применяется только в командной строке, каталог `dir` должен существовать).

В нашем случае: `--homedir ~/.gnupg/git`. Применим эту опцию для указания домашнего каталога gpg для Git во всех командах.

## Немного про gpg-agent

gpg-agent – демон (программа фонового режима) для управления секретными ключами независимо от протокола. Он применяется как служебная программа для gpg и gpgsm, а также пары других утилит.

Чаще всего используется как посредник для временного хранения пароля закрытого GPG ключа (пароль не будет запрашиваться каждый раз, когда нужен).

Агент автоматически запускается по мере необходимости программами gpg, gpgsm, gpgconf или gpg-connect-agent. Таким образом, в большинстве случаев, запускать его вручную не требуется.

При передаче утилите gpg параметра `--homedir`, она создаст отдельный процесс gpg-agent с тем же домашним каталогом (если такой еще не запущен).

Вручную остановить работающий агент:

```
gpgconf --kill --homedir ~/.gnupg/git gpg-agent
```

Еще один вариант использования – создать новый процесс как дочерний процесс gpg-agent. Таким образом, можно получить новый командный интерпретатор с настроенной должным образом средой, после выхода из которого, gpg-agent завершается в пределах нескольких секунд:

```
gpg-agent --homedir ~/.gnupg/git --daemon /bin/sh
```

В Windows gpg-agent не демонизируется (это не реализовано), и при передаче команды `--daemon` его окно все равно остается видимым. Также, при использовании gpg из состава Git, желательно добавить путь к нему в переменную окружения PATH (обычно gpg расположен в паке "c:\Program Files\Git\usr\bin"). Кроме того, для запуска git-bash, необходимо указывать его полный путь:

```
gpg-agent --homedir ~/.gnupg/git --daemon "c:/Program Files/Git/git-bash.exe"
```

## Генерация собственного GPG ключа

Новый GPG ключ будет помещен в домашний каталог gpg (открытый ключ – в связку публичных GPG ключей в файле pubring.kbx, закрытый ключ – в каталог private-keys-v1.d). Поэтому, если при генерации ключа была указана опция `--homedir`, то и для использования этого ключа необходимо будет указывать соответствующий домашний каталог.

> Если Вы не используете отдельный домашний каталога gpg для Git, то удалите опцию `--homedir ~/.gnupg/git` из всех команд.

Генерируем пару GPG ключей (открытый и закрытый) для использования в Git – это будет собственный GPG ключ для подписания коммитов и тегов. Выбираем тип ключа – «(1) RSA and RSA (default)», длина ключа – 4096, 0 – без истечения срока действия ключа, y – подтверждаем выбор, имя – User Name, Email – email@example.com, комментарий – Comment, O – проверяем и подтверждаем корректность ввода, задаем парольную фразу на файл закрытого ключа:

```
gpg --homedir ~/.gnupg/git --full-gen-key
```

Если в процессе генерации ключа для него не был автоматически создан сертификат отзыва, рекомендуется создать сертификат отзыва этого ключа вручную.

Проверяем результат:

```
gpg --homedir ~/.gnupg/git --list-secret-keys --keyid-format LONG
```

В выводе команды будут перечислены все GPG ключи, для которых у Вас есть закрытый ключ:

```
/PATH/TO/.gnupg/git/pubring.kbx
------------------------------------
sec   rsa4096/FF736DBD820C5BBC 2024-01-08 [SC]
      F1EA36127B7822281282D8CBFF736DBD820C5BBC
uid                 [ultimate] User Name (Comment) <email@example.com>
ssb   rsa4096/DF5A4F9F41E19931 2024-01-08 [E]
```

В строке `sec` указан длинный идентификатор GPG ключа. Он начинается после символа /. В данном случае идентификатор ключа – `FF736DBD820C5BBC`.

В следующей строке указан отпечаток ключа – `F1EA36127B7822281282D8CBFF736DBD820C5BBC`.

В `[SCEA]` указано назначение каждого ключа:

- `S` – Подпись (Signing).
- `C` – Подпись ключа (Certification).
- `E` – Шифрование (Encryption).
- `A` – Авторизация (Authentication). 

Экспортируем свой открытый GPG ключ (с назначением \[SC\]) в файл с бронированием ASCII (символ `!` указывает на то, что необходимо экспортировать только заданный ключ, без подключей):

```
gpg --homedir ~/.gnupg/git --armor --output /PATH/TO/UserName.asc --export FF736DBD820C5BBC!
```

Полученный публичный GPG ключ можно, например, добавить в свой профиль на GitLab или GitHub для корректной проверки подписей ваших коммитов и тегов в web-интерфейсе.

Кроме этого, может потребоваться отправить собственный публичный GPG ключ сопровождающему репозитория (или другому ответственному лицу) для добавления его в связку публичных GPG ключей допустимых подписантов.

## Настройка собственной GPG подписи в Git

Для подписания коммитов и тегов будем использовать ранее сгенерированный GPG ключ. Все настройки Git произведем для локального репозитория, но их можно применить и глобально (`--global`), для всех репозиториев на уровне пользователя.

> Обратите внимание, что если Вы используете отдельный домашний каталог gpg для Git, то необходимо обязательно настроить вызов gpg в Git, как это описано в разделе "[Настройка вызова gpg с нужной конфигурацией](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2%D0%B0-gpg-%D1%81-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE%D0%B9-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B5%D0%B9)".

Настраиваем Git на использование gpg для подписания коммитов и тегов:

```
git config --local gpg.format openpgp
```

Указываем Git какой GPG ключ использовать для подписания коммитов и тегов (используем длинный идентификатор собственного GPG ключа):

```
git config --local user.signingkey FF736DBD820C5BBC
```

Настраиваем Git на автоматическое подписание коммитов и аннотированных тегов:

```
git config --local commit.gpgsign true
```

```
git config --local tag.forceSignAnnotated true
```

## Настройка вызова gpg с нужной конфигурацией

Для вызова gpg с нужной конфигурацией будем использовать параметры `--homedir dir` и `--options file` (оба не являются обязательными и применяются только в командной строке). Общий вид команды вызова gpg в этом случае:

```
gpg [ --homedir dir ] [ --options file ] ...
```

Где:

- `--homedir dir` – задает полный путь к домашнему каталогу.
- `--options file` – указывает файл конфигурации (при этом отменяет файл конфигурации по умолчанию, который расположен в домашнем каталоге).
  
Остальные опции вызова gpg, например для настройки проверки подписей в Git, также можно передать в командной строке. Но удобнее перечислить их в файле конфигурации gpg `/PATH/TO/gpg.conf` и подключить этот файл через параметр `--options`.

За настройку вызова gpg в Git отвечает опция `gpg.openpgp.program` (или ее устаревший аналог `gpg.program`). Git не позволяет указать в этой опции параметры командной строки, поэтому создадим специальный скрипт вызова gpg с нужной конфигурацией `/PATH/TO/git-gpg.sh` и сошлемся на него. Также этот скрипт упростит дальнейшую работу с публичными GPG ключами допустимых подписантов.

### Настройка вызова gpg для всех репозиториев

Если требуется настроить только использование отдельного домашнего каталога gpg для Git и репозиториям не нужны независимые конфигурации gpg, то достаточно создать общий скрипт вызова gpg для Git `~/.gnupg/git/git-gpg.sh`:

```
#!/bin/bash
gpg --homedir ~/.gnupg/git "$@"
```

При необходимости дополнительно можно создать и подключить общий файл конфигурации gpg для Git `~/.gnupg/git/gpg.conf`. В этом случае скрипт вызова gpg для Git `~/.gnupg/git/git-gpg.sh` будет иметь следующий вид:

```
#!/bin/bash
gpg --homedir ~/.gnupg/git --options ~/.gnupg/git/gpg.conf "$@"
```

Поле чего, настраиваем Git на вызов этого скрипта глобально – для всех репозиториев на уровне пользователя. Как уже упоминалось, Git не позволяет указать здесь аргументы командной строки, поэтому все дополнительные опции должны быть прописаны в скрипте вызова или в конфигурационном файле gpg для Git:

```
git config --global gpg.openpgp.program ~/.gnupg/git/git-gpg.sh
```

### Настройка вызова gpg для отдельных репозиториев и групп

Если для каждого репозитория необходимо управлять своей собственной связкой публичных GPG ключей допустимых подписантов и, возможно, другими параметрами, то удобнее всего будет создать для каждого репозитория отдельный скрипт вызова gpg и подключить собственный файл конфигурации.

Аналогичным образом можно создать независимые конфигурации для различных групп репозиториев, например личных репозиториев и репозиториев вашей компании.

Для каждого репозитория или группы:

**1\.** Создаем собственный файл конфигурации gpg `~/.gnupg/git/<repo_name>/gpg.conf` и указываем в нем все опции, которые необходимы для настройки проверки GPG подписей в Git:

```
no-default-keyring
trusted-key long_key_ID_or_fingerprint_1
# trusted-key long_key_ID_or_fingerprint_2
keyring ~/.gnupg/git/<repo_name>/pubring.kbx
trustdb-name ~/.gnupg/git/<repo_name>/trustdb.gpg
```

Используемые опции:

- `no-default-keyring` – отключает использование связки ключей по умолчанию (расположена в домашнем каталоге gpg для Git `~/.gnupg/git`).
- `trusted-key` – задает перечень идентификаторов GPG ключей доверенных лиц (по одному на строку), ответственных за ведение списка публичных GPG ключей допустимых подписантов (участников репозитория). Каждое доверенное лицо сможет подписывать публичные GPG ключи остальных участников для подтверждения их достоверности. Обязательно добавьте идентификатор своего GPG ключа в этот список.
- `keyring` – задает полное имя, включая путь, связки публичных GPG ключей допустимых подписантов.
- `trustdb-name` – задает полное имя, включая путь, базы данных доверия.

**2\.** Создаем скрипт вызова gpg с нужной конфигурацией `~/.gnupg/git/<repo_name>/git-gpg.sh` (указываем домашний каталог gpg для Git и путь к файлу конфигурации):

```
#!/bin/bash
gpg --homedir ~/.gnupg/git --options ~/.gnupg/git/<repo_name>/gpg.conf "$@"
```

**3\.** Настраиваем Git на вызов этого скрипта. Как уже упоминалось, Git не позволяет указать здесь аргументы командной строки, поэтому все дополнительные опции должны быть прописаны в скрипте вызова или в конфигурационном файле gpg. Если Вы настраиваете группу репозиториев – повторите данную операцию для каждого из них:

```
git config --local gpg.openpgp.program ~/.gnupg/git/<repo_name>/git-gpg.sh
```

## Управление публичными GPG ключами допустимых подписантов

Этот раздел предполагает, что Вы являетесь ответственным за ведение списка публичных GPG ключей допустимых подписантов (участников репозитория). Иначе обратитесь к сопровождающему репозитория за получением готовой конфигурации.

Для проверки GPG подписей коммитов и тегов всех участников репозитория, необходимо добавить их публичные GPG ключи в связку публичных GPG ключей допустимых подписантов. Кроме того, в целях безопасности, каждый такой ключ должен быть подписан одним из доверенных лиц (ответственных за ведение списка участников репозитория).

Для работы с ключами будем использовать скрипт запуска gpg `~/.gnupg/git/<repo_name>/git-gpg.sh` соответствующего репозитория, подготовленный в разделе "[Настройка вызова gpg с нужной конфигурацией](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2%D0%B0-gpg-%D1%81-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE%D0%B9-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B5%D0%B9)". Если Вы создали общий для всех репозиториев скрипт запуска gpg `~/.gnupg/git/git-gpg.sh`, то для работы с ключами используйте именно его. Оба этих скрипта уже настроены на применение нужной конфигурации, и дополнительные опции в командной строке указывать не потребуется.

Первым делом добавляем публичные GPG ключи всех доверенных лиц, включая собственный публичный GPG ключ, в связку публичных GPG ключей допустимых подписантов (список ключей доверенных лиц [был задан](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2%D0%B0-gpg-%D0%B4%D0%BB%D1%8F-%D0%BE%D1%82%D0%B4%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B5%D0%B2-%D0%B8-%D0%B3%D1%80%D1%83%D0%BF%D0%BF) в файле конфигурации gpg `~/.gnupg/git/<repo_name>/gpg.conf`). Связка публичных ключей и база данных доверия будет автоматически созданы при добавлении первого ключа:

```
~/.gnupg/git/<repo_name>/git-gpg.sh --import /PATH/TO/<trusted_public_key.asc>
```

Никаких дополнительных действий с доверенными ключами производить не требуется, они уже имеют максимальные уровни доверия и достоверности.

После чего, добавляем публичные GPG ключи всех остальных допустимых подписантов. В качестве примера возьмем публичный GPG ключ GitHub (опубликован [тут](https://github.com/web-flow.gpg)) и сохраним его в файл `/PATH/TO/GitHub.asc`. Этим ключом подписываются коммиты, добавленные через web-интерфейс GitHub.

Для каждого публичного GPG ключа допустимого подписанта (участника репозитория):

**1\.** Проверяем подлинность ключа. Например, сравнив отпечаток ключа (key fingerprint) с отпечатком, полученным от его владельца (отпечаток ключа GitHub `5DE3 E050 9C47 EA3C F04A  42D3 4AEE 18F8 3AFD EB23`):

```
gpg --with-fingerprint --keyid-format LONG --show-keys /PATH/TO/GitHub.asc
```

```
pub   rsa2048/4AEE18F83AFDEB23 2017-08-16 [SC]
      Key fingerprint = 5DE3 E050 9C47 EA3C F04A  42D3 4AEE 18F8 3AFD EB23
uid                            GitHub (web-flow commit signing) <noreply@github.com>
```

**2\.** Если все в порядке – импортируем ключ:

```
~/.gnupg/git/<repo_name>/git-gpg.sh --import /PATH/TO/GitHub.asc
```

**3\.** И подписываем его. Для этого используем «быструю» команду `--quick-lsign-key fpr [names]`, которая непосредственно создает неэкспортируемую подпись ключа без всякого дальнейшего взаимодействия с пользователем (кроме запроса пароля). Для большей гибкости можно воспользоваться подкомандой `lsign` команды `--edit-key` (или ее сокращенной версией `--lsign-key`). В качестве подписывающего ключа будет выбран первый ключ найденный в таблице секретных ключей (изменить это поведение можно опциями `--default-key`, `--local-user` или `-u`). Подписывающий ключ обязательно должен быть указан в списке доверенных ключей в файле конфигурации gpg `~/.gnupg/git/<repo_name>/gpg.conf`. Подписанный ключ получит полный `[  full  ]` уровень достоверности:

```
~/.gnupg/git/<repo_name>/git-gpg.sh --quick-lsign-key "5DE3 E050 9C47 EA3C F04A  42D3 4AEE 18F8 3AFD EB23"
```

Проверяем получившийся список публичных GPG ключей допустимых подписантов:

```
~/.gnupg/git/<repo_name>/git-gpg.sh --list-keys --keyid-format LONG
```

В выводе команды должны быть перечислены все добавленные публичные GPG ключи:

```
/PATH/TO/.gnupg/git/<repo_name>/pubring.kbx
------------------------------------------
pub   rsa4096/FF736DBD820C5BBC 2024-01-08 [SC]
      F1EA36127B7822281282D8CBFF736DBD820C5BBC
uid                 [ultimate] User Name (Comment) <email@example.com>

pub   rsa2048/4AEE18F83AFDEB23 2017-08-16 [SC]
      5DE3E0509C47EA3CF04A42D34AEE18F83AFDEB23
uid                 [  full  ] GitHub (web-flow commit signing) <noreply@github.com>
```

Обратите внимание на уровень достоверности каждого публичного GPG ключа. Должны быть указаны следующие значения:

- `[ultimate]` – для публичных ключей всех доверенных лиц.
- `[  full  ]` – для публичных ключей всех остальных допустимых подписантов.

## Настройка проверки GPG подписей в Git

Для проверки GPG подписей в локальном Git-репозитории используем подготовленную ранее связку публичных GPG ключей допустимых подписантов и настроим Git на вызов gpg с нужной конфигурацией.

Если Вы самостоятельно подготовили всю конфигурацию как описано в предыдущих разделах, то эти параметры уже настроены в вашем локальном репозитории.

Если Вы получили готовую конфигурацию – проведите предварительную настройку своего локального репозитория. Перечень действий, пути и названия файлов могут зависеть от конфигурации, но в большинстве случаев будет достаточно:

1\. Поместить полученные файлы в каталог `~/.gnupg/git/<repo_name>`.

2\. Настроить Git на вызов gpg с нужной конфигурацией (используя ссылку на полученный скрипт вызова gpg `~/.gnupg/git/<repo_name>/git-gpg.sh`):

```
git config --local gpg.openpgp.program ~/.gnupg/git/<repo_name>/git-gpg.sh
```

Следующий шаг необходимо выполнить в любом случае, независимо от способа получения конфигурации (готовая конфигурация или самостоятельная настройка).

Задаем минимальный уровень достоверности ключа для проверки подписи. Это позволит принимать только ключи имеющие уровень достоверности не ниже `[ full ]` (т.е. только ключи доверенных лиц и ключи, которые подписаны одним из доверенных лиц):

```
git config --local gpg.minTrustLevel fully
```

На этом настройка проверки GPG подписей в локальном Git-репозитории закончена. Теперь Git выдаст результаты проверки GPG подписи согласно сформированному списку допустимых подписантов везде, где это будет запрошено.

## Передача готовой конфигурации

Готовая конфигурация расположена в каталоге `~/.gnupg/git/<repo_name>` и состоит из следующих файлов:

```
pubring.kbx
trustdb.gpg
gpg.conf
git-gpg.sh
```

Сопровождающий репозитория может передать эти файлы остальным участникам для проверки GPG подписей коммитов и тегов в их локальных репозиториях.

Участники репозитория, получившие готовую конфигурацию, должны настроить у себя проверку GPG подписей, как это описано в разделе "[Настройка проверки GPG подписей в Git](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8-gpg-%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%B5%D0%B9-%D0%B2-git)".

Обратите внимание, что использование опции `--homedir` может вызвать ошибку при подписании коммитов и тегов у некоторых участников репозитория. Это связано с тем, что ранее используемый собственный GPG ключ останется в старом домашнем каталоге gpg. Для устранения ошибки необходимо будет перенести собственный GPG ключ в новый домашний каталог gpg для Git, либо отказаться от использования опции `--homedir`.
